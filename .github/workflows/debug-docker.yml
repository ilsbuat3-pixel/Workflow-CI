name: DEBUG Docker Login Only

on: workflow_dispatch

jobs:
  debug-login:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Pakai Docker yang sudah ada di runner (tidak perlu install)
    - name: Check Docker Status
      run: |
        echo "ðŸ” Checking Docker on runner..."
        docker --version || echo "Docker not installed"
        docker system info | head -5 || echo "Cannot get docker info"
    
    # 2. TEST LOGIN SAJA (tanpa push)
    - name: Test Docker Hub Login
      run: |
        echo "ðŸ” ===== TEST DOCKER HUB LOGIN ====="
        
        # Cek secret ada
        echo "Username from secret: ${{ secrets.DOCKER_USERNAME }}"
        echo "Password length: ${#DOCKER_PASSWORD}"
        
        # Test login
        echo ""
        echo "Attempting login..."
        LOGIN_RESULT=$(echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin 2>&1)
        
        if echo "$LOGIN_RESULT" | grep -q "Login Succeeded"; then
          echo "âœ… LOGIN SUCCESSFUL!"
          echo "$LOGIN_RESULT"
          
          # Cek user info
          echo ""
          echo "ðŸ” User info from Docker:"
          docker system info | grep -i "username\|name" || echo "No user info"
        else
          echo "âŒ LOGIN FAILED!"
          echo ""
          echo "Error details:"
          echo "$LOGIN_RESULT"
          echo ""
          echo "ðŸš¨ Possible issues:"
          echo "1. Token expired/revoked"
          echo "2. Wrong username/password"
          echo "3. Docker Hub account issues"
        fi
      env:
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
    
    # 3. TEST dengan curl ke Docker Hub API
    - name: Test Docker Hub API
      run: |
        echo "ðŸŒ ===== TEST DOCKER HUB API ====="
        
        # Test 1: Public API endpoint
        echo "Testing Docker Hub public API..."
        curl -s "https://hub.docker.com/v2/" | head -5
        
        # Test 2: Check your repository
        echo ""
        echo "Checking repository: inirianokw/mlflow-diabetes"
        RESPONSE=$(curl -s "https://hub.docker.com/v2/repositories/inirianokw/mlflow-diabetes/")
        
        if echo "$RESPONSE" | grep -q "not found"; then
          echo "âŒ Repository NOT FOUND"
        elif echo "$RESPONSE" | grep -q '"name":"mlflow-diabetes"'; then
          echo "âœ… Repository EXISTS"
          echo "   Visibility: $(echo "$RESPONSE" | grep -o '"is_private":[^,]*' | cut -d: -f2)"
          echo "   Status: $(echo "$RESPONSE" | grep -o '"status":[^,]*' | cut -d: -f2 | tr -d '"')"
        else
          echo "âš ï¸  Unknown response"
          echo "$RESPONSE" | head -10
        fi
    
    # 4. Test dengan Docker CLI yang sudah ada
    - name: Quick Docker Test
      run: |
        echo "ðŸ³ ===== QUICK DOCKER TEST ====="
        
        # Cek jika Docker tersedia
        if ! command -v docker &> /dev/null; then
          echo "Docker not available on runner"
          echo "Skipping Docker tests"
          exit 0
        fi
        
        # Test simple Docker command
        echo "Testing Docker pull..."
        docker pull hello-world 2>&1 | head -5 || echo "Cannot pull"
        
        echo ""
        echo "Test completed"