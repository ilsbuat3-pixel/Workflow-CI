name: MLflow CI/CD Advanced (4 pts)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Run weekly on Sunday
  workflow_dispatch:  # Manual trigger

jobs:
  mlflow-ci-cd-advanced:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Set up job
    - name: Set up job
      run: echo "üöÄ Starting MLflow CI/CD Advanced Pipeline (4 pts)..."
      
    # 2. Run actions checkout v3
    - name: Checkout code
      uses: actions/checkout@v3
      
    # 3. Set up Python 3.12.7
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    # 4. Check Env
    - name: Check Environment
      run: |
        echo "=== Environment Check ==="
        echo "Python version: $(python --version)"
        echo "Pip version: $(pip --version)"
        echo "Working directory: $(pwd)"
        echo "Repository structure:"
        ls -la
        echo "MLProject folder:"
        ls -la MLProject/
        
    # 5. Install dependencies
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow==2.10.0 scikit-learn==1.3.0 pandas==2.0.3 numpy==1.24.3
        
    # 6. Run MLflow project
    - name: Run MLflow project
      id: mlflow-run
      run: |
        echo "üìä Running MLflow project..."
        cd MLProject
        
        # Clean previous runs
        rm -rf mlruns run_id.txt 2>/dev/null || true
        
        # Run MLflow project dengan parameter
        mlflow run . \
          --experiment-name "github-ci-advanced" \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42
        
        echo "‚úÖ MLflow training completed"
        
    # 7. Get latest MLflow run id
    - name: Get latest MLflow run id
      id: get-run-id
      run: |
        cd MLProject
        
        # Method 1: Read from file created by modelling.py
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "üìå Run ID from file: $RUN_ID"
        else
          # Method 2: Find from mlruns directory
          RUN_ID=$(find mlruns -name "meta.yaml" -type f -exec grep -h "run_id:" {} \; | head -1 | awk '{print $2}')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "üìå Run ID from mlruns: $RUN_ID"
        fi
        
        # Save run_id to environment for later steps
        echo "MLFLOW_RUN_ID=$RUN_ID" >> $GITHUB_ENV
        
    # 8. Install Python dependencies (for Docker build)
    - name: Install Python dependencies
      run: |
        pip install mlflow[extras]
        pip install docker
        pip install google-auth  # For Google Drive if needed
        
    # 9. Upload to Google Drive (Kita ganti dengan Upload to GitHub)
    - name: Upload to GitHub
      uses: actions/upload-artifact@v3
      with:
        name: mlflow-artifacts-${{ github.run_number }}
        path: |
          MLProject/mlruns/
          MLProject/*.pkl
          MLProject/*.json
        retention-days: 30
        
    # 10. Build Docker Model dengan mlflow build-docker
    - name: Build Docker Model
      if: success() && steps.get-run-id.outputs.run_id != ''
      run: |
        echo "üê≥ Building Docker image with mlflow build-docker..."
        
        cd MLProject
        
        # Build Docker image dari model MLflow
        mlflow models build-docker \
          -m "runs:/${{ steps.get-run-id.outputs.run_id }}/model" \
          -n "mlflow-diabetes-${{ github.sha:0:8 }}" \
          --enable-mlserver
        
        echo "‚úÖ Docker image built successfully"
        
    # 11. Log in to Docker Hub
    - name: Log in to Docker Hub
      if: success() && github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # 12. Tag Docker Image
    - name: Tag Docker Image
      if: success() && github.event_name != 'pull_request'
      run: |
        echo "üè∑Ô∏è Tagging Docker image..."
        
        docker tag "mlflow-diabetes-${{ github.sha:0:8 }}" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha:0:8 }}"
        docker tag "mlflow-diabetes-${{ github.sha:0:8 }}" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker tag "mlflow-diabetes-${{ github.sha:0:8 }}" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:run-${{ github.run_number }}"
        
        echo "‚úÖ Docker images tagged"
        
    # 13. Push Docker Image
    - name: Push Docker Image
      if: success() && github.event_name != 'pull_request'
      run: |
        echo "‚¨ÜÔ∏è Pushing Docker images to Docker Hub..."
        
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha:0:8 }}"
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:run-${{ github.run_number }}"
        
        echo "üéâ Docker images pushed to Docker Hub!"
        
    # 14. Post: Log out from Docker Hub
    - name: Post Log in to Docker Hub
      if: always()
      run: |
        docker logout || true
        echo "‚úÖ Logged out from Docker Hub"
        
    # 15. Post: Clean up Python setup
    - name: Post Set up Python 3.12.7
      if: always()
      run: |
        echo "‚úÖ Python 3.12.7 setup completed and cleaned up"
        
    # 16. Post: Clean up checkout
    - name: Post Run actions checkout v3
      if: always()
      run: |
        echo "‚úÖ Checkout v3 completed"
        
    # 17. Complete job
    - name: Complete job
      if: always()
      run: |
        echo "=".repeat(70)
        echo "‚úÖ MLflow CI/CD Advanced Pipeline COMPLETED SUCCESSFULLY!"
        echo "=".repeat(70)
        echo ""
        echo "üìä Training Results:"
        echo "  - Run ID: ${{ steps.get-run-id.outputs.run_id }}"
        echo "  - Workflow: #${{ github.run_number }}"
        echo "  - Commit: ${{ github.sha }}"
        echo ""
        echo "üê≥ Docker Images:"
        echo "  - ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        echo "  - ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha:0:8 }}"
        echo ""
        echo "üéâ All steps completed according to Advanced criteria (4 pts)"