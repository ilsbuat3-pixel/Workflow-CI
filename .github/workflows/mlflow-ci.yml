name: MLflow CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  mlflow-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. MASUK KE MLProject SEBELUM APA PUN
    - name: Navigate to MLProject
      run: |
        echo "üìÅ Navigating to MLProject folder..."
        cd MLProject
        echo "Current dir: $(pwd)"
        ls -la

    # 3. Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'  # Sesuai conda.yaml Anda

    # 4. Install dependencies
    - name: Install dependencies
      run: |
        cd MLProject  # Pastikan di MLProject
        pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy
        pip install matplotlib seaborn joblib
        pip install mlflow[extras]

    # 5. Clean environment
    - name: Clean MLflow environment
      run: |
        cd MLProject
        echo "üßπ Cleaning MLflow files..."
        rm -rf mlruns run_id.txt mlflow.db .mlflow 2>/dev/null || true

    # 6. Run MLflow project
    - name: Run MLflow project
      id: run-mlflow
      run: |
        cd MLProject
        
        echo "üöÄ Running MLflow project..."
        echo "Files in MLProject:"
        ls -la
        
        mlflow run . \
          --experiment-name "mlflow-ci-pipeline" \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42 \
          --env-manager=local
        
        # Ambil run ID
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "‚úÖ Run ID from file: $RUN_ID"
        else
          RUN_ID=$(find . -name "meta.yaml" -type f | head -1 | xargs grep "run_id:" | awk '{print $2}')
          echo "‚úÖ Run ID from meta.yaml: $RUN_ID"
        fi
        
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "$RUN_ID" > run_id.txt

    # 7. Verify model
    - name: Verify Model Artifacts
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "üîç Verifying model for Run ID: $RUN_ID"
          
          # Dari struktur Anda, model ada di:
          # mlruns/222819206179196404/854758fb1b84453ea1d3281434c0c67c/artifacts/model/
          # DAN di mlruns/222819206179196404/models/m-2a081b3ab10140809d66b1c5dfa98cde/artifacts/
          
          echo "Looking for model in mlruns..."
          
          # Cari folder run yang punya artifacts/model
          MODEL_RUN=$(find mlruns -type d -name "artifacts" | xargs -I {} dirname {} | head -1)
          if [ -d "$MODEL_RUN/artifacts/model" ]; then
            echo "‚úÖ Model found at: $MODEL_RUN/artifacts/model"
            ls -la "$MODEL_RUN/artifacts/model/"
          else
            echo "‚ö†Ô∏è Checking registered models..."
            find mlruns -type d -name "m-*" | head -3
          fi
        else
          echo "‚ùå run_id.txt not found"
          exit 1
        fi

    # 8. Build Docker
    - name: Build Docker image
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "üê≥ Building Docker for Run ID: $RUN_ID"
          
          mlflow models build-docker \
            -m "runs:/$RUN_ID/model" \
            -n "mlflow-diabetes-model"
            
          echo "‚úÖ Docker image built"
        else
          echo "‚ùå run_id.txt not found"
          exit 1
        fi

    # 9. Install Docker
    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker

    # 10. Login Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    # 11. Tag & Push
    - name: Tag and Push Docker image
      run: |
        docker tag "mlflow-diabetes-model" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker tag "mlflow-diabetes-model" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
        echo "üéâ Pushed to Docker Hub: ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes"

    # 12. Upload artifacts
    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: MLProject/mlruns
        retention-days: 30

    # 13. Complete
    - name: Complete pipeline
      run: |
        echo "‚úÖ MLflow CI/CD Pipeline COMPLETED!"
        echo "üìÅ Structure was: Workflow ‚Üí MLProject ‚Üí run"