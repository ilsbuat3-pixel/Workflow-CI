name: MLflow CI/CD Advanced (4 pts)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  mlflow-ci-cd-advanced:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Set up job
    - name: Set up job
      run: echo "üöÄ Starting MLflow CI/CD Advanced Pipeline..."
      
    # 2. Run actions checkout v4
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 3. Setup Miniconda
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniconda-version: "latest"
        python-version: "3.12.7"
        activate-environment: mlflow-env
        auto-activate-base: false
        
    # 4. Check Env
    - name: Check Environment
      shell: bash -l {0}
      run: |
        echo "Python: $(python --version)"
        echo "Conda: $(conda --version)"
        echo "Starting MLflow CI/CD..."
        
    # 5. Install dependencies via conda
    - name: Install dependencies
      shell: bash -l {0}
      run: |
        conda install -c conda-forge -y \
          mlflow \
          scikit-learn \
          pandas \
          numpy \
          pip

    - name: Clean MLflow database
      shell: bash -l {0}
      run: |
        echo "üßπ Membersihkan database MLflow yang rusak..."
        
        # Hapus file database MLflow yang ada
        rm -f mlflow.db 2>/dev/null || true
        rm -rf mlruns 2>/dev/null || true
        
        # Inisialisasi database baru
        mlflow db upgrade sqlite:///mlflow.db
        
        echo "‚úÖ Database telah dibersihkan"
        
    # 6. Run MLflow project WITH conda
    - name: Run MLflow project
      id: mlflow-run
      shell: bash -l {0}
      run: |
        echo "üìä Running MLflow project..."
        cd MLProject
        
        rm -rf mlruns run_id.txt 2>/dev/null || true

        export MLFLOW_TRACKING_URI="sqlite:///mlflow.db"

        
        mlflow run . \
          --experiment-name "github-ci-advanced" \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42
        
        # Store run ID
        RUN_ID=$(find mlruns -name "meta.yaml" | xargs grep -h "run_id:" | awk '{print $2}' | head -1)
        echo "$RUN_ID" > run_id.txt
        echo "Run ID: $RUN_ID"
        
    # 7. Get latest MLflow run id
    - name: Get latest MLflow run id
      id: get-run-id
      shell: bash -l {0}
      run: |
        cd MLProject
        RUN_ID=$(cat run_id.txt)
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "Run ID: $RUN_ID"
        
    # 8. Install additional dependencies for Docker
    - name: Install Python dependencies for Docker
      shell: bash -l {0}
      run: |
        conda install -c conda-forge -y \
          docker-py \
          mlflow-skinny
        
    # 9. Upload to GitHub
    - name: Upload to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: MLProject/mlruns/
        retention-days: 30
        
    # 10. Build Docker Model dengan mlflow build-docker
    - name: Build Docker Model
      if: success() && steps.get-run-id.outputs.run_id != ''
      shell: bash -l {0}
      run: |
        echo "üê≥ Building Docker image..."
        cd MLProject

        RUN_ID=$(cat run_id.txt)
        echo "Using Run ID: $RUN_ID"
        
        # Verify model exists
        echo "Checking model artifacts..."
        if [ -d "mlruns/0/$RUN_ID/artifacts/model" ]; then
          echo "‚úÖ Model artifacts found"
          ls -la mlruns/0/$RUN_ID/artifacts/model/
        else
          echo "‚ùå Model artifacts not found in default path, searching..."
          find mlruns -name "model" -type d
        fi
        
        # Build Docker image
        mlflow models build-docker \
          -m "runs:/$RUN_ID/model" \
          -n "mlflow-diabetes" \
          --enable-mlserver
        
    # 11. Install Docker for image management
    - name: Install Docker CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        sudo systemctl enable docker
        
    # 12. Log in to Docker Hub
    - name: Log in to Docker Hub
      if: success()
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # 13. Tag Docker Image
    - name: Tag Docker Image
      if: success()
      run: |
        sudo docker tag "mlflow-diabetes" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        sudo docker tag "mlflow-diabetes" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
    # 14. Push Docker Image
    - name: Push Docker Image
      if: success()
      run: |
        sudo docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        sudo docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
        echo "üéâ Docker images pushed to Docker Hub!"
        
    # 15. Complete job
    - name: Complete job
      shell: bash -l {0}
      run: |
        echo "‚úÖ MLflow CI/CD Advanced Pipeline Completed!"
        echo "Docker Hub: ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes"