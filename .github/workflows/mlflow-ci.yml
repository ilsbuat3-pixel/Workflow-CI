name: MLflow CI/CD Advanced Fixed

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  mlflow-ci-cd-advanced:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Setup Miniconda
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniconda-version: "latest"
        python-version: "3.12.7"
        activate-environment: mlflow-env
        auto-activate-base: false
        
    # 2. Install dependencies
    - name: Install dependencies
      shell: bash -l {0}
      run: |
        conda install -c conda-forge -y \
          mlflow \
          scikit-learn \
          pandas \
          numpy \
          pip
        
    # 3. üî¥ PERBAIKAN: Inisialisasi Database dengan Benar
    - name: Initialize MLflow Database
      shell: bash -l {0}
      run: |
        echo "üîß Menginisialisasi database MLflow dari nol..."
        
        # Hapus SEMUA file database dan tracking
        rm -rf mlflow.db mlruns .mlflow 2>/dev/null || true
        
        # Buat database baru dengan skema lengkap
        mlflow db init sqlite:///mlflow.db
        
        # Verifikasi database dibuat
        if [ -f "mlflow.db" ]; then
          echo "‚úÖ Database berhasil dibuat: $(ls -lh mlflow.db)"
          
          # Tes koneksi database
          echo "Mengecek tabel database..."
          sqlite3 mlflow.db ".tables" || echo "Database kosong, akan dibuat saat run pertama"
        else
          echo "‚ùå Database gagal dibuat"
          exit 1
        fi
        
    # 4. Run MLflow project dengan tracking URI eksplisit
    - name: Run MLflow project
      id: mlflow-run
      shell: bash -l {0}
      run: |
        echo "üìä Running MLflow project..."
        cd MLProject
        
        # Set environment variable untuk MLflow
        export MLFLOW_TRACKING_URI="sqlite:///mlflow.db"
        export MLFLOW_EXPERIMENT_NAME="github-ci-advanced"
        
        # Hapus run sebelumnya
        rm -rf mlruns run_id.txt 2>/dev/null || true
        
        echo "MLFLOW_TRACKING_URI: $MLFLOW_TRACKING_URI"
        
        # Jalankan dengan --no-conda untuk menghindari konflik environment
        mlflow run . \
          --experiment-name "$MLFLOW_EXPERIMENT_NAME" \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42 \
          --no-conda  # üî¥ Penting: Gunakan environment yang sudah aktif
        
        # Simpan run ID
        RUN_ID=$(sqlite3 mlflow.db "SELECT run_uuid FROM runs ORDER BY start_time DESC LIMIT 1;" 2>/dev/null || \
                 find . -name "meta.yaml" -type f | xargs grep "run_id:" | head -1 | awk '{print $2}')
        
        if [ -z "$RUN_ID" ]; then
          # Fallback: cari di directory mlruns
          RUN_ID=$(find mlruns -name "meta.yaml" -type f | head -1 | xargs grep "run_id:" | awk '{print $2}')
        fi
        
        echo "$RUN_ID" > run_id.txt
        echo "Run ID: $RUN_ID"
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        
    # 5. Verifikasi Run
    - name: Verify MLflow Run
      shell: bash -l {0}
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "‚úÖ Run ditemukan: $RUN_ID"
          
          # Cek apakah model artifacts ada
          if [ -d "mlruns/0/$RUN_ID/artifacts/model" ]; then
            echo "‚úÖ Model artifacts ditemukan"
            ls -la mlruns/0/$RUN_ID/artifacts/model/
          else
            echo "‚ö†Ô∏è  Model artifacts tidak ditemukan, mencari alternative..."
            find mlruns -name "model" -type d
          fi
        else
          echo "‚ùå Run ID tidak ditemukan"
          exit 1
        fi
        
    # 6. Build Docker Model
    - name: Build Docker Model
      if: success()
      shell: bash -l {0}
      run: |
        echo "üê≥ Building Docker image..."
        cd MLProject

        RUN_ID=$(cat run_id.txt)
        echo "Using Run ID: $RUN_ID"
        
        # Gunakan file-based tracking untuk Docker build
        mlflow models build-docker \
          -m "runs:/$RUN_ID/model" \
          -n "mlflow-diabetes" \
          --enable-mlserver
        
    # 7. Install Docker
    - name: Install Docker CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        
    # 8. Login Docker Hub
    - name: Log in to Docker Hub
      if: success()
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # 9. Tag & Push Docker
    - name: Tag and Push Docker Image
      if: success()
      run: |
        sudo docker tag "mlflow-diabetes" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        sudo docker tag "mlflow-diabetes" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        sudo docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        sudo docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
    # 10. Complete
    - name: Complete job
      run: |
        echo "‚úÖ MLflow CI/CD Pipeline Selesai!"