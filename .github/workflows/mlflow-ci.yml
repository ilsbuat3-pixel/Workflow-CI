name: MLflow CI/CD Pipeline - Fixed Docker Install

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  mlflow-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Navigate to MLProject
    - name: Navigate to MLProject
      run: |
        echo "üìÅ Entering MLProject folder..."
        cd MLProject
        echo "Current dir: $(pwd)"
        ls -la

    # 3. Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'

    # 4. Install Python dependencies
    - name: Install Python dependencies
      run: |
        cd MLProject
        pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy
        pip install matplotlib seaborn joblib
        pip install mlflow[extras]

    # 5. Clean environment
    - name: Clean MLflow environment
      run: |
        cd MLProject
        echo "üßπ Cleaning MLflow files..."
        rm -rf mlruns run_id.txt mlflow.db .mlflow 2>/dev/null || true

    # 6. Run MLflow project
    - name: Run MLflow project
      id: run-mlflow
      run: |
        cd MLProject
        
        echo "üöÄ Running MLflow project..."
        
        mlflow run . \
          --experiment-name "mlflow-ci-pipeline" \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42 \
          --env-manager=local
        
        # Get run ID
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "‚úÖ Run ID: $RUN_ID"
        else
          RUN_ID=$(find . -name "meta.yaml" -type f | head -1 | xargs grep "run_id:" | awk '{print $2}')
          echo "‚úÖ Run ID: $RUN_ID"
        fi
        
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "$RUN_ID" > run_id.txt

    # 7. Verify model
    - name: Verify Model Artifacts
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "üîç Model verification for Run ID: $RUN_ID"
          
          # Simple check - just see if mlruns exists
          if [ -d "mlruns" ]; then
            echo "‚úÖ mlruns directory exists"
            echo "üìÅ Structure:"
            find mlruns -type f -name "*.pkl" -o -name "*.joblib" -o -name "MLmodel" | head -10
          else
            echo "‚ùå mlruns not found"
            exit 1
          fi
        else
          echo "‚ùå run_id.txt not found"
          exit 1
        fi

    # üî• PERBAIKAN UTAMA: Install Docker dengan cara yang benar
    - name: Install Docker (Fixed)
      run: |
        echo "üê≥ Installing Docker without conflicts..."
        
        # Hapus docker yang mungkin sudah ada
        sudo apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
        
        # Update package lists
        sudo apt-get update
        
        # Install dependencies
        sudo apt-get install -y \
            apt-transport-https \
            ca-certificates \
            curl \
            gnupg \
            lsb-release
        
        # Add Docker's official GPG key
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        
        # Set up stable repository
        echo \
          "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        # Install Docker Engine
        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io
        
        # Verify installation
        sudo docker --version
        echo "‚úÖ Docker installed successfully"

    # 8. Build Docker image
    - name: Build Docker image with MLflow
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "üê≥ Building Docker for Run ID: $RUN_ID"
          
          # Build dengan MLflow
          mlflow models build-docker \
            -m "runs:/$RUN_ID/model" \
            -n "mlflow-diabetes-model" \
            --enable-mlserver
            
          echo "‚úÖ Docker image built"
        else
          echo "‚ùå run_id.txt not found"
          exit 1
        fi

    # 9. Login Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 10. Tag & Push Docker
    - name: Tag and Push Docker image
      run: |
        echo "üè∑Ô∏è Tagging Docker image..."

        NEW_REPO_NAME="mlflow-diabetes-v2"  
        
        # Tambahkan sudo karena baru install
        sudo docker tag "mlflow-diabetes-model" "${{ secrets.DOCKER_USERNAME }}/$NEW_REPO_NAME:latest"
        sudo docker tag "mlflow-diabetes-model" "${{ secrets.DOCKER_USERNAME }}/$NEW_REPO_NAME:${{ github.sha }}"

        
        echo "üì§ Pushing to Docker Hub..."
        echo "Repository: ${{ secrets.DOCKER_USERNAME }}/$NEW_REPO_NAME"
        
        sudo docker push "${{ secrets.DOCKER_USERNAME }}/$NEW_REPO_NAME:latest"
        sudo docker push "${{ secrets.DOCKER_USERNAME }}/$NEW_REPO_NAME:${{ github.sha }}"
        
        echo "üéâ Successfully pushed to Docker Hub!"
        echo "üì¶ Image: ${{ secrets.DOCKER_USERNAME }}/$NEW_REPO_NAME"
        echo "üè∑Ô∏è Tags: latest, ${{ github.sha }}"
        echo "üîó View: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/$NEW_REPO_NAME"


    # 11. Upload artifacts (optional)
    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: MLProject/mlruns
        retention-days: 30

    # 12. Complete
    - name: Complete pipeline
      run: |
        echo "‚úÖ MLflow CI/CD Pipeline COMPLETED!"
        echo "üìä Model trained and Docker image pushed"