name: MLflow CI Pipeline - For Your Setup

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  train-model:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install mlflow scikit-learn pandas numpy matplotlib seaborn
        pip install mlflow[extras]  # Untuk build-docker

    # ğŸ”´ TAMBAH: Clean environment dulu
    - name: Clean MLflow environment
      run: |
        rm -rf mlruns mlflow.db .mlflow 2>/dev/null || true

    - name: Run MLflow Project
      id: mlflow-run
      run: |
        cd MLProject
        
        # Hapus run sebelumnya
        rm -rf mlruns run_id.txt 2>/dev/null || true
        
        # Run dengan parameter yang Anda punya
        mlflow run . \
          --env-manager=local \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42
        
        # Simpan run ID dengan cara yang lebih reliable
        RUN_ID=$(find mlruns -name "meta.yaml" -type f | head -1 | xargs grep "run_id:" | awk '{print $2}')
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "$RUN_ID" > run_id.txt
        echo "âœ… Run ID: $RUN_ID"

    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: MLProject/mlruns
        retention-days: 30

    # ğŸ”´ PERBAIKI: Cara ambil RUN_ID
    - name: Build Docker image with MLflow
      id: build-docker
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "Building Docker for Run ID: $RUN_ID"
        else
          # Fallback ke cara lama
          RUN_ID=$(ls mlruns/0 2>/dev/null | head -n 1)
          echo "Using first directory: $RUN_ID"
        fi
        
        # ğŸ”´ SESUAIKAN: Nama image pakai username Anda
        mlflow models build-docker \
          -m "runs:/$RUN_ID/model" \
          -n "inirianokw/mlflow-diabetes"

    # ğŸ”´ PERBAIKI: Install Docker dulu
    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker

    # ğŸ”´ SESUAIKAN: Login dengan username dan PASSWORD (bukan TOKEN)
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}  # Harus: inirianokw
        password: ${{ secrets.DOCKER_PASSWORD }}  # Token: dckr_pat_...

    # ğŸ”´ SESUAIKAN: Push dengan username Anda
    - name: Push Docker image to Docker Hub
      run: |
        # ğŸ”´ GANTI: putriiantarii â†’ inirianokw
        docker push "inirianokw/mlflow-diabetes:latest"
        docker push "inirianokw/mlflow-diabetes:${{ github.sha }}"
        
        echo "ğŸ‰ Docker images pushed!"
        echo "Image: inirianokw/mlflow-diabetes"
        echo "Tags: latest, ${{ github.sha }}"

    - name: Complete pipeline
      run: |
        echo "âœ… MLflow CI Pipeline Completed!"
        echo "ğŸ“Š Model trained and Docker image built"
        echo "ğŸ³ Docker Hub: inirianokw/mlflow-diabetes"