name: MLflow CI Pipeline - Compatible with Your Code

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  train-model:
    runs-on: ubuntu-latest

    steps:
    # 1. Setup Python (pakai 3.10 seperti di conda.yaml Anda)
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 2. Install semua dependencies yang ada di script Anda
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy
        pip install matplotlib seaborn joblib  # Semua yang ada di script Anda
        pip install mlflow[extras]  # Untuk build-docker

    # 3. Clean environment untuk hindari konflik
    - name: Clean MLflow environment
      run: |
        echo "ğŸ§¹ Cleaning MLflow environment..."
        rm -rf mlruns mlflow.db .mlflow MLProject/mlruns 2>/dev/null || true

    # 4. Run MLflow Project - SESUAI dengan modelling.py Anda
    - name: Run MLflow Project
      id: run-mlflow
      run: |
        cd MLProject
        
        echo "ğŸš€ Running MLflow project with YOUR parameters..."
        echo "Data path: data/diabetes_preprocessed_full.csv"
        echo "Test size: 0.2"
        echo "Random state: 42"
        
        # Run dengan parameter PERSIS seperti di script Anda
        mlflow run . \
          --env-manager=local \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42
        
        echo "âœ… MLflow run completed"
        
        # CARA YANG PASTI DAPAT RUN_ID: dari file yang dibuat modelling.py
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "ğŸ“ Run ID from modelling.py: $RUN_ID"
        else
          # Fallback jika file tidak dibuat
          RUN_ID=$(find mlruns -name "meta.yaml" -type f | head -1 | xargs grep "run_id:" | awk '{print $2}')
          echo "ğŸ“ Run ID from meta.yaml: $RUN_ID"
        fi
        
        # Simpan untuk step berikutnya
        if [ -n "$RUN_ID" ]; then
          echo "$RUN_ID" > run_id.txt
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        else
          echo "âŒ Failed to get RUN_ID"
          exit 1
        fi

    # 5. Verify Model - SESUAI dengan struktur dari modelling.py Anda
    - name: Verify Model Artifacts
      run: |
        cd MLProject
        
        echo "ğŸ” Verifying model artifacts..."
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "Run ID to check: $RUN_ID"
          
          # Model dari script Anda harusnya di 3 lokasi:
          # 1. mlruns/0/$RUN_ID/artifacts/model/ (dari mlflow.sklearn.log_model)
          # 2. best_model.pkl (dari pickle.dump)
          # 3. best_model.joblib (dari joblib.dump)
          
          echo "Checking standard MLflow location..."
          if [ -d "mlruns/0/$RUN_ID/artifacts/model" ]; then
            echo "âœ… MLflow model found!"
            ls -la mlruns/0/$RUN_ID/artifacts/model/
          else
            echo "âš ï¸ Checking for pickle/joblib files..."
            
            # Cari file yang dibuat script Anda
            if [ -f "best_model.pkl" ]; then
              echo "âœ… best_model.pkl found (from pickle.dump)"
            fi
            
            if [ -f "best_model.joblib" ]; then
              echo "âœ… best_model.joblib found (from joblib.dump)"
            fi
            
            # Cari model di registered model (karena Anda pakai registered_model_name)
            echo "Checking registered models..."
            find mlruns -type d -name "m-*" 2>/dev/null | head -3
          fi
          
          # Tampilkan struktur lengkap untuk debugging
          echo "ğŸ“ Full mlruns structure:"
          find mlruns -type f -name "*.pkl" -o -name "*.joblib" -o -name "MLmodel" -o -name "conda.yaml" | head -15
          
        else
          echo "âŒ run_id.txt not found"
          exit 1
        fi

    # 6. Build Docker - SESUAI dengan model URI yang benar
    - name: Build Docker image with MLflow
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "ğŸ³ Building Docker image for Run ID: $RUN_ID"
          
          # Coba beberapa URI yang mungkin:
          # 1. runs:/$RUN_ID/model (standard)
          # 2. runs:/$RUN_ID/artifacts/model
          # 3. file path jika tidak ketemu
          
          echo "Trying URI: runs:/$RUN_ID/model"
          
          mlflow models build-docker \
            -m "runs:/$RUN_ID/model" \
            -n "mlflow-diabetes-model" \
            --enable-mlserver
            
          echo "âœ… Docker image built successfully"
        else
          echo "âŒ run_id.txt not found"
          exit 1
        fi

    # 7. Install Docker untuk push
    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl enable docker
        sudo systemctl start docker

    # 8. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    # 9. Tag and Push Docker image
    - name: Tag and Push Docker image to Docker Hub
      run: |
        echo "ğŸ·ï¸ Tagging Docker image..."
        
        # Tag dengan username Anda
        docker tag "mlflow-diabetes-model" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker tag "mlflow-diabetes-model" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
        echo "ğŸ“¤ Pushing to Docker Hub..."
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
        echo "ğŸ‰ Successfully pushed to Docker Hub!"
        echo "Image: ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes"
        echo "Tags: latest, ${{ github.sha }}"

    # 10. Upload artifacts (optional)
    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: MLProject/mlruns
        retention-days: 30

    # 11. Complete
    - name: Complete pipeline
      run: |
        echo "âœ… MLflow CI Pipeline COMPLETED!"
        echo "ğŸ¯ Model trained using YOUR modelling.py script"
        echo "ğŸ³ Docker image: ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes"
        echo "ğŸ“Š Check Docker Hub for your deployed model"