name: MLflow CI/CD Advanced (4 pts)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  mlflow-ci-cd-advanced:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Set up job
    - name: Set up job
      run: echo "üöÄ Starting MLflow CI/CD Advanced Pipeline..."
      
    # 2. Run actions checkout v4
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 3. Set up Python 3.12.7
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    # 4. Check Env
    - name: Check Environment
      run: |
        echo "Python: $(python --version)"
        echo "Starting MLflow CI/CD..."
        
    # 5. Install dependencies
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy
        
    # 6. Run MLflow project
    - name: Run MLflow project
      id: mlflow-run
      run: |
        echo "üìä Running MLflow project..."
        cd MLProject
        
        rm -rf mlruns run_id.txt 2>/dev/null || true
        
        mlflow run . \
          --env-manager local \
          --experiment-name "github-ci-advanced" \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42
        
    # 7. Get latest MLflow run id
    - name: Get latest MLflow run id
      id: get-run-id
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Run ID: $RUN_ID"
        else
          RUN_ID=$(find mlruns -name "meta.yaml" | head -1 | xargs grep "run_id:" | awk '{print $2}')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Run ID: $RUN_ID"
        fi
        
    # 8. Install Python dependencies for Docker
    - name: Install Python dependencies
      run: |
        pip install mlflow[extras]
        pip install docker
        
    # 9. Upload to GitHub
    - name: Upload to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: MLProject/mlruns/
        retention-days: 30
        
    # 10. Build Docker Model dengan mlflow build-docker
    - name: Build Docker Model
      if: success() && steps.get-run-id.outputs.run_id != ''
      run: |
        echo "üê≥ Building Docker image..."
        
        cd MLProject
        
        mlflow models build-docker \
          -m "runs:/${{ steps.get-run-id.outputs.run_id }}/model" \
          -n "mlflow-diabetes"
        
    # 11. Log in to Docker Hub
    - name: Log in to Docker Hub
      if: success()
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # 12. Tag Docker Image
    - name: Tag Docker Image
      if: success()
      run: |
        docker tag "mlflow-diabetes" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker tag "mlflow-diabetes" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
    # 13. Push Docker Image
    - name: Push Docker Image
      if: success()
      run: |
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
        echo "üéâ Docker images pushed to Docker Hub!"
        
    # 14. Complete job
    - name: Complete job
      run: |
        echo "‚úÖ MLflow CI/CD Advanced Pipeline Completed!"
        echo "Docker Hub: ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes"