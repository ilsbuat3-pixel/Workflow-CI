name: DEBUG Docker Push Only

on: workflow_dispatch

jobs:
  debug-docker-push:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Install Docker minimal
    - name: Install Docker Minimal
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        docker --version
    
    # 2. LOGIN TEST dengan berbagai cara
    - name: Test Docker Hub Login Methods
      run: |
        echo "üîê ===== TESTING DOCKER LOGIN METHODS ====="
        
        # Method 1: Manual login dengan token
        echo ""
        echo "Method 1: Manual login with token..."
        if echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "inirianokw" --password-stdin; then
          echo "‚úÖ Method 1 SUCCESS"
        else
          echo "‚ùå Method 1 FAILED"
        fi
        
        # Method 2: Login action
        echo ""
        echo "Method 2: Login action (current method)..."
        # Simulasikan login action
        echo "${{ secrets.DOCKER_PASSWORD }}" > /tmp/token.txt
        if docker login -u "inirianokw" --password-stdin < /tmp/token.txt; then
          echo "‚úÖ Method 2 SUCCESS"
        else
          echo "‚ùå Method 2 FAILED"
        fi
        
        # Method 3: Login with registry
        echo ""
        echo "Method 3: Login with registry URL..."
        if echo "${{ secrets.DOCKER_PASSWORD }}" | docker login docker.io -u "inirianokw" --password-stdin; then
          echo "‚úÖ Method 3 SUCCESS"
        else
          echo "‚ùå Method 3 FAILED"
        fi
        
        # Verify login
        echo ""
        echo "üîç Login verification:"
        docker system info | grep -i "username" || echo "No username in system info"
    
    # 3. TEST PUSH dengan image SIMPLE
    - name: Test Push Simple Image
      run: |
        echo "üß™ ===== TEST PUSH SIMPLE IMAGE ====="
        
        # Pull image kecil
        docker pull alpine:latest
        
        # Test 1: Push ke repository RANDOM (auto-create)
        RANDOM_NAME="test-$(date +%s)"
        echo ""
        echo "Test 1: Push to NEW repository: inirianokw/$RANDOM_NAME"
        docker tag alpine:latest "inirianokw/$RANDOM_NAME:latest"
        
        if docker push "inirianokw/$RANDOM_NAME:latest" 2>&1 | tee /tmp/push1.log; then
          echo "üéâ Test 1 SUCCESS!"
          echo "Token BERFUNGSI! Repository baru bisa dibuat otomatis"
          
          # Test 2: Sekarang coba mlflow-diabetes
          echo ""
          echo "Test 2: Now trying mlflow-diabetes..."
          docker tag alpine:latest "inirianokw/mlflow-diabetes:test-$(date +%s)"
          
          if docker push "inirianokw/mlflow-diabetes:test-$(date +%s)"; then
            echo "üéâ Test 2 SUCCESS! mlflow-diabetes works NOW"
            echo ""
            echo "üö® KESIMPULAN: Repository mlflow-diabetes sebelumnya CORRUPTED"
            echo "Tapi sekarang FIXED setelah push pertama berhasil"
          else
            echo "‚ùå Test 2 FAILED - mlflow-diabetes MASIH bermasalah"
            echo ""
            echo "üìã ERROR DETAILS:"
            docker push "inirianokw/mlflow-diabetes:test-$(date +%s)" 2>&1 | tail -20
          fi
        else
          echo "‚ùå Test 1 FAILED"
          echo ""
          echo "üî¥ MASALAH KRITIS:"
          echo "Token TIDAK BERFUNGSI sama sekali"
          echo ""
          echo "üìÑ ERROR LOG:"
          cat /tmp/push1.log
          echo ""
          echo "üö® ACTION REQUIRED:"
          echo "1. Buat Docker Hub account BARU"
          echo "2. Atau hubungi Docker Hub support"
        fi
    
    # 4. Check Repository Status via API
    - name: Check Repository Status
      run: |
        echo "üîç ===== CHECK REPOSITORY VIA API ====="
        
        # Cek repository mlflow-diabetes
        echo "Checking: inirianokw/mlflow-diabetes"
        
        # Try Docker Hub API v2
        RESPONSE=$(curl -s "https://hub.docker.com/v2/repositories/inirianokw/mlflow-diabetes/")
        
        echo "API Response:"
        echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
        
        # Cek jika repository private
        if echo "$RESPONSE" | grep -q '"is_private":true'; then
          echo "‚ö†Ô∏è  Repository is PRIVATE"
          echo "Private repos butuh token dengan specific permissions"
        else
          echo "‚úÖ Repository is PUBLIC"
        fi
        
        # Cek user permissions
        if echo "$RESPONSE" | grep -q '"user":'; then
          echo "‚úÖ Repository belongs to user"
        fi