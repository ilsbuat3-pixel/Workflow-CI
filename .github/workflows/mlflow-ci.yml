name: MLflow CI Pipeline Simple

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  train-model:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install mlflow scikit-learn pandas numpy matplotlib seaborn
        pip install mlflow[extras]  # Untuk build-docker

    # üî¥ TAMBAHKAN: Clean database sebelum run
    - name: Clean MLflow environment
      run: |
        echo "üßπ Membersihkan environment MLflow..."
        rm -rf mlruns mlflow.db .mlflow 2>/dev/null || true

    - name: Run MLflow Project
      id: run-mlflow
      run: |
        cd MLProject
        
        # Bersihkan directory project
        rm -rf mlruns run_id.txt 2>/dev/null || true
        
        # Jalankan dengan parameter sesuai project Anda
        mlflow run . \
          --env-manager=local \
          -P data_path=data/diabetes_preprocessed_full.csv \
          -P test_size=0.2 \
          -P random_state=42
        
        # Simpan run ID dengan cara yang lebih reliable
        RUN_ID=$(find mlruns -name "meta.yaml" -type f | head -1 | xargs grep "run_id:" | awk '{print $2}')
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "$RUN_ID" > run_id.txt
        echo "‚úÖ Run ID: $RUN_ID"

    - name: Verify Model Artifacts
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "Verifying model for Run ID: $RUN_ID"
          
          # Cek apakah model ada
          if [ -d "mlruns/0/$RUN_ID/artifacts/model" ]; then
            echo "‚úÖ Model artifacts found"
            ls -la mlruns/0/$RUN_ID/artifacts/model/
          else
            echo "‚ö†Ô∏è Looking for model in alternative locations..."
            find mlruns -name "model" -type d
          fi
        else
          echo "‚ùå No run_id.txt found"
          exit 1
        fi

    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts
        path: MLProject/mlruns
        retention-days: 30

    - name: Build Docker image with MLflow
      id: build-docker
      run: |
        cd MLProject
        
        if [ -f "run_id.txt" ]; then
          RUN_ID=$(cat run_id.txt)
          echo "Building Docker image for Run ID: $RUN_ID"
          
          # Verifikasi lagi model ada
          if [ -d "mlruns/0/$RUN_ID/artifacts/model" ]; then
            mlflow models build-docker \
              -m "runs:/$RUN_ID/model" \
              -n "mlflow-diabetes-model"
            
            echo "‚úÖ Docker image built successfully"
          else
            echo "‚ùå Model not found at mlruns/0/$RUN_ID/artifacts/model/"
            echo "Available artifacts:"
            find mlruns -type f -name "*.pkl" -o -name "*.model" -o -name "MLmodel" | head -10
            exit 1
          fi
        else
          echo "‚ùå run_id.txt not found"
          exit 1
        fi

    # üî¥ PERBAIKAN: Install Docker terlebih dahulu
    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Tag and Push Docker image to Docker Hub
      run: |
        # Tag dengan username Docker Hub Anda dan versi
        docker tag "mlflow-diabetes-model" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker tag "mlflow-diabetes-model" "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
        # Push ke Docker Hub
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:latest"
        docker push "${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes:${{ github.sha }}"
        
        echo "üéâ Docker images pushed to Docker Hub!"
        echo "Image: ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes"
        echo "Tags: latest, ${{ github.sha }}"

    - name: Complete pipeline
      run: |
        echo "‚úÖ MLflow CI Pipeline Completed Successfully!"
        echo "üìä Model trained and Docker image built"
        echo "üê≥ Docker Hub: ${{ secrets.DOCKER_USERNAME }}/mlflow-diabetes"